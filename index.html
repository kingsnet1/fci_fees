<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIRST SCLASS SHS - Fee Management System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <style>
        :root {
            --primary-color: #1a5f7a;
            --secondary-color: #57cc99;
            --accent-color: #ff9a3c;
            --danger-color: #ff6b6b;
            --warning-color: #ffd93d;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --border-radius: 8px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f0f7ff;
            color: var(--dark-color);
            line-height: 1.6;
        }
        
        .container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* Header Styles */
        header {
            background: linear-gradient(135deg, var(--primary-color), #2a8fb8);
            color: white;
            padding: 20px 0;
            box-shadow: var(--box-shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo i {
            font-size: 2.5rem;
            color: var(--secondary-color);
        }
        
        .logo h1 {
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        .logo span {
            color: var(--secondary-color);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            border-radius: 30px;
        }
        
        .user-info i {
            font-size: 1.2rem;
        }
        
        /* Main Content */
        .main-content {
            display: flex;
            min-height: calc(100vh - 140px);
        }
        
        /* Sidebar */
        .sidebar {
            width: 250px;
            background-color: white;
            padding: 25px 0;
            box-shadow: var(--box-shadow);
            border-radius: 0 0 var(--border-radius) var(--border-radius);
        }
        
        .menu {
            list-style: none;
        }
        
        .menu-item {
            padding: 15px 25px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        
        .menu-item:hover {
            background-color: rgba(26, 95, 122, 0.05);
            border-left-color: var(--primary-color);
        }
        
        .menu-item.active {
            background-color: rgba(26, 95, 122, 0.1);
            border-left-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .menu-item i {
            width: 20px;
            text-align: center;
        }
        
        /* Content Area */
        .content-area {
            flex: 1;
            padding: 25px;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .page-header h2 {
            color: var(--primary-color);
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #154c63;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #45b883;
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: var(--dark-color);
        }
        
        .btn-warning:hover {
            background-color: #e6c437;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #e55a5a;
            transform: translateY(-2px);
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 0.85rem;
        }
        
        /* Cards */
        .card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .card-header h3 {
            color: var(--primary-color);
        }
        
        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background-color: #f1f7fb;
            padding: 15px 10px;
            text-align: left;
            color: var(--primary-color);
            font-weight: 600;
            border-bottom: 2px solid #e1e8f0;
        }
        
        td {
            padding: 15px 10px;
            border-bottom: 1px solid #eee;
        }
        
        tr:hover {
            background-color: #f9fdfe;
        }
        
        .status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .status.paid {
            background-color: rgba(87, 204, 153, 0.2);
            color: #2a8b67;
        }
        
        .status.owing {
            background-color: rgba(255, 107, 107, 0.2);
            color: #d63031;
        }
        
        .status.partial {
            background-color: rgba(255, 217, 61, 0.2);
            color: #b38f00;
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .form-row {
            display: flex;
            gap: 20px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 25px;
            text-align: center;
            border-top: 5px solid var(--primary-color);
        }
        
        .summary-card h3 {
            font-size: 1.1rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .summary-card .amount {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark-color);
        }
        
        .summary-card.total-balance {
            border-top-color: var(--danger-color);
        }
        
        .summary-card.total-collected {
            border-top-color: var(--secondary-color);
        }
        
        .summary-card.total-students {
            border-top-color: var(--accent-color);
        }
        
        /* Footer */
        footer {
            background-color: var(--primary-color);
            color: white;
            text-align: center;
            padding: 20px 0;
            margin-top: 30px;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-header h3 {
            color: var(--primary-color);
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
        }
        
        .close-btn:hover {
            color: var(--danger-color);
        }
        
        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Alert Messages */
        .alert {
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .alert-success {
            background-color: rgba(87, 204, 153, 0.2);
            border-left: 4px solid var(--secondary-color);
            color: #2a8b67;
        }
        
        .alert-error {
            background-color: rgba(255, 107, 107, 0.2);
            border-left: 4px solid var(--danger-color);
            color: #d63031;
        }
        
        .alert-warning {
            background-color: rgba(255, 217, 61, 0.2);
            border-left: 4px solid var(--warning-color);
            color: #b38f00;
        }
        
        /* Search and Filter */
        .search-box {
            position: relative;
            width: 300px;
        }
        
        .search-box input {
            padding-right: 40px;
        }
        
        .search-box i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }
        
        /* Responsive */
        @media (max-width: 992px) {
            .main-content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                padding: 15px 0;
            }
            
            .menu {
                display: flex;
                overflow-x: auto;
            }
            
            .menu-item {
                padding: 10px 15px;
                white-space: nowrap;
            }
            
            .search-box {
                width: 100%;
                margin-top: 10px;
            }
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .summary-cards {
                grid-template-columns: 1fr;
            }
            
            table {
                display: block;
                overflow-x: auto;
            }
        }
        
        /* Login Screen */
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 40px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        
        .login-container .logo {
            justify-content: center;
            margin-bottom: 30px;
        }
        
        /* Chart Placeholder */
        .chart-placeholder {
            width: 100%;
            height: 300px;
            background-color: #f9f9f9;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--border-radius);
            flex-direction: column;
        }
        
        .chart-placeholder i {
            font-size: 3rem;
            color: #ccc;
            margin-bottom: 10px;
        }
        
        /* Action Buttons Container */
        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        /* Print Styles */
        @media print {
            .sidebar, .btn, .search-box, footer {
                display: none !important;
            }
            
            .content-area {
                padding: 0;
            }
            
            .card {
                box-shadow: none;
                border: 1px solid #ddd;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="login-screen">
        <div class="login-container">
            <div class="logo">
                <i class="fas fa-graduation-cap"></i>
                <h1>FIRST SCLASS <span>SHS</span></h1>
            </div>
            <h2 style="text-align: center; color: var(--primary-color); margin-bottom: 30px;">Fee Management System</h2>
            
            <form id="login-form">
                <div class="form-group">
                    <label for="login-email">Email Address</label>
                    <input type="email" class="form-control" id="login-email" placeholder="admin@school.edu.gh" required>
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" class="form-control" id="login-password" placeholder="Enter password" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
                <div id="login-error" class="alert alert-error" style="display: none; margin-top: 15px;"></div>
            </form>
            
            <div style="margin-top: 20px; text-align: center; color: #666; font-size: 0.9rem;">
                <p><i class="fas fa-info-circle"></i> For administrators only</p>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app-container" style="display: none;">
        <!-- Header -->
        <header>
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <i class="fas fa-graduation-cap"></i>
                        <h1>FIRST SCLASS <span>SHS</span> - Fee Management System</h1>
                    </div>
                    <div class="user-info">
                        <i class="fas fa-user-shield"></i>
                        <span id="user-display-name">Administrator</span>
                        <button id="logout-btn" class="btn btn-danger btn-sm">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Main Content -->
        <div class="container main-content">
            <!-- Sidebar -->
            <nav class="sidebar">
                <ul class="menu">
                    <li class="menu-item active" data-page="dashboard">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </li>
                    <li class="menu-item" data-page="students">
                        <i class="fas fa-users"></i>
                        <span>Manage Students</span>
                    </li>
                    <li class="menu-item" data-page="courses">
                        <i class="fas fa-book"></i>
                        <span>Manage Courses</span>
                    </li>
                    <li class="menu-item" data-page="fees">
                        <i class="fas fa-money-check-alt"></i>
                        <span>Set Fee Structure</span>
                    </li>
                    <li class="menu-item" data-page="payments">
                        <i class="fas fa-credit-card"></i>
                        <span>Record Payments</span>
                    </li>
                    <li class="menu-item" data-page="reports">
                        <i class="fas fa-chart-bar"></i>
                        <span>Reports & Analytics</span>
                    </li>
                    <li class="menu-item" data-page="settings">
                        <i class="fas fa-cog"></i>
                        <span>System Settings</span>
                    </li>
                </ul>
            </nav>
            
            <!-- Content Area -->
            <div class="content-area">
                <!-- Dashboard Page -->
                <div class="page active" id="dashboard">
                    <div class="page-header">
                        <h2><i class="fas fa-tachometer-alt"></i> Dashboard</h2>
                        <div class="date-display" style="color: var(--primary-color); font-weight: 600;">
                            <i class="fas fa-calendar-alt"></i> <span id="current-date"></span>
                        </div>
                    </div>
                    
                    <!-- Loading Indicator -->
                    <div id="dashboard-loading" class="spinner" style="display: none;"></div>
                    
                    <!-- Summary Cards -->
                    <div class="summary-cards" id="summary-cards">
                        <div class="summary-card total-balance">
                            <h3>Total Balance Owed</h3>
                            <div class="amount">₵ <span id="total-balance">0</span></div>
                            <p>From <span id="owing-students">0</span> students</p>
                        </div>
                        <div class="summary-card total-collected">
                            <h3>Total Collected</h3>
                            <div class="amount">₵ <span id="total-collected">0</span></div>
                            <p>This academic year</p>
                        </div>
                        <div class="summary-card total-students">
                            <h3>Total Students</h3>
                            <div class="amount"><span id="total-students">0</span></div>
                            <p>Across all programs</p>
                        </div>
                        <div class="summary-card">
                            <h3>Courses/Programs</h3>
                            <div class="amount"><span id="total-courses">0</span></div>
                            <p>Active programs</p>
                        </div>
                    </div>
                    
                    <!-- Recent Activities -->
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-history"></i> Recent Activities</h3>
                            <button class="btn btn-primary" id="refresh-activities">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                        <div id="activities-loading" class="spinner" style="display: none;"></div>
                        <table id="recent-activities-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Student</th>
                                    <th>Activity</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="recent-activities">
                                <!-- Recent activities will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Students with Highest Balances -->
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-exclamation-triangle"></i> Top 5 Students with Highest Balances</h3>
                            <button class="btn btn-primary" id="view-all-balances">View All Balances</button>
                        </div>
                        <div id="balances-loading" class="spinner" style="display: none;"></div>
                        <table id="top-balances-table">
                            <thead>
                                <tr>
                                    <th>Student ID</th>
                                    <th>Name</th>
                                    <th>Course</th>
                                    <th>Balance Owed</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="top-balances">
                                <!-- Top balances will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Manage Students Page -->
                <div class="page" id="students">
                    <div class="page-header">
                        <h2><i class="fas fa-users"></i> Manage Students</h2>
                        <div>
                            <button class="btn btn-warning" id="export-students-btn">
                                <i class="fas fa-download"></i> Export
                            </button>
                            <button class="btn btn-primary" id="add-student-btn">
                                <i class="fas fa-plus"></i> Add New Student
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3>All Students</h3>
                            <div class="search-box">
                                <input type="text" class="form-control" id="student-search" placeholder="Search students...">
                                <i class="fas fa-search"></i>
                            </div>
                        </div>
                        <div id="students-loading" class="spinner" style="display: none;"></div>
                        <table id="students-table">
                            <thead>
                                <tr>
                                    <th>Student ID</th>
                                    <th>Full Name</th>
                                    <th>Course/Program</th>
                                    <th>Total Fees</th>
                                    <th>Amount Paid</th>
                                    <th>Balance</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="students-table-body">
                                <!-- Students will be populated by JavaScript -->
                            </tbody>
                        </table>
                        <div id="students-empty" style="text-align: center; padding: 40px; color: #666; display: none;">
                            <i class="fas fa-user-slash" style="font-size: 3rem; margin-bottom: 15px;"></i>
                            <h3>No Students Found</h3>
                            <p>Add your first student to get started</p>
                        </div>
                    </div>
                </div>
                
                <!-- Manage Courses Page -->
                <div class="page" id="courses">
                    <div class="page-header">
                        <h2><i class="fas fa-book"></i> Manage Courses/Programs</h2>
                        <button class="btn btn-primary" id="add-course-btn">
                            <i class="fas fa-plus"></i> Add New Course
                        </button>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3>All Courses/Programs</h3>
                            <div class="search-box">
                                <input type="text" class="form-control" id="course-search" placeholder="Search courses...">
                                <i class="fas fa-search"></i>
                            </div>
                        </div>
                        <div id="courses-loading" class="spinner" style="display: none;"></div>
                        <table id="courses-table">
                            <thead>
                                <tr>
                                    <th>Course Code</th>
                                    <th>Course Name</th>
                                    <th>Students Enrolled</th>
                                    <th>Admission Fee</th>
                                    <th>Tuition Fee</th>
                                    <th>Registration Fee</th>
                                    <th>Hostel Fee</th>
                                    <th>Total Fee</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="courses-table-body">
                                <!-- Courses will be populated by JavaScript -->
                            </tbody>
                        </table>
                        <div id="courses-empty" style="text-align: center; padding: 40px; color: #666; display: none;">
                            <i class="fas fa-book" style="font-size: 3rem; margin-bottom: 15px;"></i>
                            <h3>No Courses Found</h3>
                            <p>Add your first course to get started</p>
                        </div>
                    </div>
                </div>
                
                <!-- Set Fee Structure Page -->
                <div class="page" id="fees">
                    <div class="page-header">
                        <h2><i class="fas fa-money-check-alt"></i> Set Fee Structure</h2>
                        <button class="btn btn-primary" id="set-fees-btn">
                            <i class="fas fa-cog"></i> Configure Fees
                        </button>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3>Current Fee Structure by Course</h3>
                            <button class="btn btn-warning" id="export-fees-btn">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                        <div id="fees-loading" class="spinner" style="display: none;"></div>
                        <div id="fee-structure-container">
                            <!-- Fee structure will be populated by JavaScript -->
                        </div>
                        <div id="fees-empty" style="text-align: center; padding: 40px; color: #666; display: none;">
                            <i class="fas fa-money-bill-wave" style="font-size: 3rem; margin-bottom: 15px;"></i>
                            <h3>No Fee Structure Found</h3>
                            <p>Add courses first to set fee structure</p>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-info-circle"></i> Fee Structure Guidelines</h3>
                        </div>
                        <div style="padding: 20px;">
                            <p>As an administrator, you can set the following fees for each course/program:</p>
                            <ul style="margin-left: 20px; margin-top: 10px;">
                                <li><strong>Admission Fee:</strong> One-time fee paid upon admission</li>
                                <li><strong>Tuition Fee:</strong> Academic fee per academic year</li>
                                <li><strong>Registration Fee:</strong> Annual registration fee</li>
                                <li><strong>Hostel Fee:</strong> Optional fee for boarding students</li>
                            </ul>
                            <p style="margin-top: 15px;">The system will automatically calculate the total fee for each student based on their assigned course and track payments against this total.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Record Payments Page -->
                <div class="page" id="payments">
                    <div class="page-header">
                        <h2><i class="fas fa-credit-card"></i> Record Payments</h2>
                        <button class="btn btn-warning" id="export-payments-btn">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3>Record New Payment</h3>
                        </div>
                        <div style="padding: 20px;">
                            <form id="payment-form">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="payment-student">Select Student</label>
                                        <select class="form-control" id="payment-student" required>
                                            <option value="">-- Select Student --</option>
                                            <!-- Options will be populated by JavaScript -->
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="payment-amount">Amount (₵)</label>
                                        <input type="number" class="form-control" id="payment-amount" min="1" required>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="payment-date">Payment Date</label>
                                        <input type="date" class="form-control" id="payment-date" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="payment-method">Payment Method</label>
                                        <select class="form-control" id="payment-method" required>
                                            <option value="Cash">Cash</option>
                                            <option value="Mobile Money">Mobile Money</option>
                                            <option value="Bank Transfer">Bank Transfer</option>
                                            <option value="Cheque">Cheque</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="payment-type">Payment Type</label>
                                        <select class="form-control" id="payment-type" required>
                                            <option value="Tuition">Tuition Fee</option>
                                            <option value="Admission">Admission Fee</option>
                                            <option value="Registration">Registration Fee</option>
                                            <option value="Hostel">Hostel Fee</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="payment-reference">Reference Number (Optional)</label>
                                        <input type="text" class="form-control" id="payment-reference" placeholder="Transaction/Receipt No.">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="payment-notes">Notes (Optional)</label>
                                    <textarea class="form-control" id="payment-notes" rows="3" placeholder="Additional notes about this payment..."></textarea>
                                </div>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-check-circle"></i> Record Payment
                                </button>
                                <button type="button" class="btn btn-secondary" id="clear-payment-form">
                                    <i class="fas fa-times"></i> Clear Form
                                </button>
                            </form>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3>Recent Payments</h3>
                            <button class="btn btn-primary" id="refresh-payments">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                        <div id="payments-loading" class="spinner" style="display: none;"></div>
                        <table id="payments-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Student</th>
                                    <th>Payment Method</th>
                                    <th>Type</th>
                                    <th>Amount</th>
                                    <th>Received By</th>
                                    <th>Reference</th>
                                </tr>
                            </thead>
                            <tbody id="recent-payments">
                                <!-- Recent payments will be populated by JavaScript -->
                            </tbody>
                        </table>
                        <div id="payments-empty" style="text-align: center; padding: 40px; color: #666; display: none;">
                            <i class="fas fa-credit-card" style="font-size: 3rem; margin-bottom: 15px;"></i>
                            <h3>No Payments Recorded</h3>
                            <p>Record your first payment to get started</p>
                        </div>
                    </div>
                </div>
                
                <!-- Reports Page -->
                <div class="page" id="reports">
                    <div class="page-header">
                        <h2><i class="fas fa-chart-bar"></i> Reports & Analytics</h2>
                        <div>
                            <button class="btn btn-warning" id="print-report-btn">
                                <i class="fas fa-print"></i> Print
                            </button>
                            <button class="btn btn-primary" id="generate-report-btn">
                                <i class="fas fa-file-export"></i> Generate Report
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3>Fee Collection Overview</h3>
                            <select class="form-control" id="report-period" style="width: 200px;">
                                <option value="all">All Time</option>
                                <option value="year">This Year</option>
                                <option value="month">This Month</option>
                                <option value="week">This Week</option>
                            </select>
                        </div>
                        <div class="chart-placeholder" id="fee-chart-placeholder">
                            <i class="fas fa-chart-pie"></i>
                            <p>Fee collection chart would appear here</p>
                            <p style="font-size: 0.9rem; color: #777;">(In a full implementation, this would show visual analytics)</p>
                        </div>
                        <div style="padding: 20px;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Total Expected Fees</label>
                                    <div class="summary-card" style="padding: 15px; margin: 0;">
                                        <div class="amount">₵ <span id="report-total-expected">0</span></div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Total Collected</label>
                                    <div class="summary-card" style="padding: 15px; margin: 0;">
                                        <div class="amount">₵ <span id="report-total-collected">0</span></div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Collection Rate</label>
                                    <div class="summary-card" style="padding: 15px; margin: 0;">
                                        <div class="amount"><span id="report-collection-rate">0</span>%</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3>Students Owing Fees</h3>
                            <div>
                                <button class="btn btn-warning" id="send-reminders-btn">
                                    <i class="fas fa-envelope"></i> Send Reminders
                                </button>
                                <button class="btn btn-danger" id="export-owing-btn">
                                    <i class="fas fa-download"></i> Export List
                                </button>
                            </div>
                        </div>
                        <div id="report-loading" class="spinner" style="display: none;"></div>
                        <table id="owing-table">
                            <thead>
                                <tr>
                                    <th>Student ID</th>
                                    <th>Name</th>
                                    <th>Course</th>
                                    <th>Contact</th>
                                    <th>Amount Owed</th>
                                    <th>Last Payment</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="owing-students-table">
                                <!-- Students owing fees will be populated by JavaScript -->
                            </tbody>
                        </table>
                        <div id="owing-empty" style="text-align: center; padding: 40px; color: #666; display: none;">
                            <i class="fas fa-check-circle" style="font-size: 3rem; margin-bottom: 15px; color: var(--secondary-color);"></i>
                            <h3>All Fees Paid!</h3>
                            <p>No students are currently owing fees</p>
                        </div>
                    </div>
                </div>
                
                <!-- Settings Page -->
                <div class="page" id="settings">
                    <div class="page-header">
                        <h2><i class="fas fa-cog"></i> System Settings</h2>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-user-cog"></i> Administrator Settings</h3>
                        </div>
                        <div style="padding: 20px;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="current-user">Current User</label>
                                    <input type="text" class="form-control" id="current-user" readonly>
                                </div>
                                <div class="form-group">
                                    <label for="user-role">Role</label>
                                    <input type="text" class="form-control" id="user-role" value="Administrator" readonly>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="academic-year">Academic Year</label>
                                <input type="text" class="form-control" id="academic-year" value="2023/2024">
                            </div>
                            <button class="btn btn-primary" id="save-settings">
                                <i class="fas fa-save"></i> Save Settings
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-database"></i> Data Management</h3>
                        </div>
                        <div style="padding: 20px;">
                            <div class="form-row">
                                <div class="form-group">
                                    <button class="btn btn-warning" id="backup-data-btn" style="width: 100%;">
                                        <i class="fas fa-file-export"></i> Backup Data
                                    </button>
                                </div>
                                <div class="form-group">
                                    <button class="btn btn-danger" id="clear-data-btn" style="width: 100%;">
                                        <i class="fas fa-trash"></i> Clear Test Data
                                    </button>
                                </div>
                            </div>
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span>Warning: These actions cannot be undone. Always backup before clearing data.</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-info-circle"></i> System Information</h3>
                        </div>
                        <div style="padding: 20px;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Version</label>
                                    <input type="text" class="form-control" value="2.0.0" readonly>
                                </div>
                                <div class="form-group">
                                    <label>Last Updated</label>
                                    <input type="text" class="form-control" id="last-updated" readonly>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Database Status</label>
                                <div class="form-control" id="db-status" style="background-color: #e8f5e9; color: #2e7d32; font-weight: 600;">
                                    <i class="fas fa-check-circle"></i> Connected to Firebase
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <footer>
            <div class="container">
                <p>© <span id="current-year"></span> FIRST SCLASS SHS - Fee Management System v2.0</p>
                <p style="font-size: 0.9rem; opacity: 0.8;">Powered by Firebase | For administrative use only</p>
            </div>
        </footer>
    </div>
    
    <!-- Modals -->
    
    <!-- Add Student Modal -->
    <div class="modal" id="add-student-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> Add New Student</h3>
                <button class="close-btn" id="close-student-modal">&times;</button>
            </div>
            <form id="student-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="student-id">Student ID *</label>
                        <input type="text" class="form-control" id="student-id" required>
                        <small style="color: #666;">Unique identifier for the student</small>
                    </div>
                    <div class="form-group">
                        <label for="student-name">Full Name *</label>
                        <input type="text" class="form-control" id="student-name" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="student-course">Course/Program *</label>
                        <select class="form-control" id="student-course" required>
                            <option value="">-- Select Course --</option>
                            <!-- Options will be populated by JavaScript -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="student-phone">Phone Number</label>
                        <input type="tel" class="form-control" id="student-phone" placeholder="024-123-4567">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="student-email">Email Address</label>
                        <input type="email" class="form-control" id="student-email" placeholder="student@email.com">
                    </div>
                    <div class="form-group">
                        <label for="student-hostel">Hostel Status</label>
                        <select class="form-control" id="student-hostel">
                            <option value="No">Day Student</option>
                            <option value="Yes">Boarding Student</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="student-gender">Gender</label>
                        <select class="form-control" id="student-gender">
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="admission-date">Admission Date</label>
                        <input type="date" class="form-control" id="admission-date">
                    </div>
                </div>
                <div class="form-group">
                    <label for="initial-payment">Initial Payment (₵)</label>
                    <input type="number" class="form-control" id="initial-payment" min="0" value="0">
                    <small style="color: #666;">Optional initial payment on registration</small>
                </div>
                <div class="form-group">
                    <label for="student-address">Address (Optional)</label>
                    <textarea class="form-control" id="student-address" rows="2" placeholder="Residential address"></textarea>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> Save Student
                    </button>
                    <button type="button" class="btn btn-secondary" id="cancel-student-form">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Add Course Modal -->
    <div class="modal" id="add-course-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-book-medical"></i> Add New Course/Program</h3>
                <button class="close-btn" id="close-course-modal">&times;</button>
            </div>
            <form id="course-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="course-code">Course Code *</label>
                        <input type="text" class="form-control" id="course-code" required>
                        <small style="color: #666;">Short code for the course (e.g., SCI001)</small>
                    </div>
                    <div class="form-group">
                        <label for="course-name">Course Name *</label>
                        <input type="text" class="form-control" id="course-name" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="admission-fee">Admission Fee (₵) *</label>
                        <input type="number" class="form-control" id="admission-fee" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="tuition-fee">Tuition Fee (₵) *</label>
                        <input type="number" class="form-control" id="tuition-fee" min="0" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="registration-fee">Registration Fee (₵) *</label>
                        <input type="number" class="form-control" id="registration-fee" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="hostel-fee">Hostel Fee (₵) *</label>
                        <input type="number" class="form-control" id="hostel-fee" min="0" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="course-description">Description (Optional)</label>
                    <textarea class="form-control" id="course-description" rows="3" placeholder="Brief description of the course..."></textarea>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> Save Course
                    </button>
                    <button type="button" class="btn btn-secondary" id="cancel-course-form">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Set Fees Modal -->
    <div class="modal" id="set-fees-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-cog"></i> Configure Fee Structure</h3>
                <button class="close-btn" id="close-fees-modal">&times;</button>
            </div>
            <div style="padding: 20px;">
                <p>Select a course to update its fee structure:</p>
                <div class="form-group">
                    <label for="select-course-fees">Course/Program</label>
                    <select class="form-control" id="select-course-fees">
                        <option value="">-- Select Course --</option>
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
                
                <div id="fee-configuration" style="margin-top: 25px;">
                    <!-- Fee configuration form will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- View Student Details Modal -->
    <div class="modal" id="view-student-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user"></i> Student Details</h3>
                <button class="close-btn" id="close-view-student-modal">&times;</button>
            </div>
            <div id="student-details-content" style="padding: 20px;">
                <!-- Student details will be populated by JavaScript -->
            </div>
        </div>
    </div>
    
    <!-- Payment Receipt Modal -->
    <div class="modal" id="receipt-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-receipt"></i> Payment Receipt</h3>
                <button class="close-btn" id="close-receipt-modal">&times;</button>
            </div>
            <div id="receipt-content" style="padding: 20px;">
                <!-- Receipt content will be populated by JavaScript -->
            </div>
            <div style="padding: 20px; border-top: 1px solid #eee;">
                <button class="btn btn-primary" id="print-receipt-btn">
                    <i class="fas fa-print"></i> Print Receipt
                </button>
                <button class="btn btn-secondary" id="close-receipt-btn">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==================== FIREBASE CONFIGURATION ====================
        // REPLACE WITH YOUR FIREBASE CONFIGURATION
        const firebaseConfig = {
    apiKey: "AIzaSyD7CW5QVKgkmXjOIY2Hu_tdDcX8t-RNRWY",
    authDomain: "fci-fees.firebaseapp.com",
    projectId: "fci-fees",
    storageBucket: "fci-fees.firebasestorage.app",
    messagingSenderId: "395004982322",
    appId: "1:395004982322:web:a8b587ea91bf24ccb5f82b"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
</script>
        
        // ==================== GLOBAL VARIABLES ====================
        let currentUser = null;
        let students = [];
        let courses = [];
        let payments = [];
        let activities = [];
        
        // ==================== AUTHENTICATION ====================
        
        // Check auth state
        auth.onAuthStateChanged((user) => {
            if (user) {
                // User is signed in
                currentUser = user;
                showApp();
                setupRealtimeListeners();
            } else {
                // User is signed out
                showLogin();
            }
        });
        
        // Login function
        async function handleLogin(email, password) {
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                return userCredential.user;
            } catch (error) {
                throw error;
            }
        }
        
        // Logout function
        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                auth.signOut();
            }
        }
        
        // ==================== FIRESTORE FUNCTIONS ====================
        
        // Setup real-time listeners
        function setupRealtimeListeners() {
            // Listen for courses
            db.collection('courses').onSnapshot((snapshot) => {
                courses = [];
                snapshot.forEach((doc) => {
                    courses.push({ id: doc.id, ...doc.data() });
                });
                populateCoursesTable();
                populateCourseSelects();
                populateFeeStructure();
                updateDashboardTotals();
            });
            
            // Listen for students
            db.collection('students').onSnapshot((snapshot) => {
                students = [];
                snapshot.forEach((doc) => {
                    students.push({ id: doc.id, ...doc.data() });
                });
                populateStudentsTable();
                populatePaymentStudentSelect();
                updateDashboardTotals();
                populateOwingStudentsTable();
                populateTopBalances();
            });
            
            // Listen for payments
            db.collection('payments')
                .orderBy('timestamp', 'desc')
                .limit(50)
                .onSnapshot((snapshot) => {
                    payments = [];
                    snapshot.forEach((doc) => {
                        payments.push({ id: doc.id, ...doc.data() });
                    });
                    populateRecentPayments();
                    populateRecentActivities();
                    updateDashboardTotals();
                });
        }
        
        // Add student to Firestore
        async function addStudent(studentData) {
            try {
                // Check if student ID already exists
                const existingStudent = students.find(s => s.studentId === studentData.studentId);
                if (existingStudent) {
                    throw new Error('Student ID already exists');
                }
                
                const docRef = await db.collection('students').add({
                    ...studentData,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUser.email
                });
                
                // Update course student count
                await db.collection('courses').doc(studentData.courseId).update({
                    students: firebase.firestore.FieldValue.increment(1)
                });
                
                return docRef.id;
            } catch (error) {
                throw error;
            }
        }
        
        // Update student in Firestore
        async function updateStudent(studentId, updateData) {
            try {
                await db.collection('students').doc(studentId).update({
                    ...updateData,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: currentUser.email
                });
            } catch (error) {
                throw error;
            }
        }
        
        // Add course to Firestore
        async function addCourse(courseData) {
            try {
                // Check if course code already exists
                const existingCourse = courses.find(c => c.code === courseData.code);
                if (existingCourse) {
                    throw new Error('Course code already exists');
                }
                
                const docRef = await db.collection('courses').add({
                    ...courseData,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUser.email,
                    students: 0
                });
                
                return docRef.id;
            } catch (error) {
                throw error;
            }
        }
        
        // Update course in Firestore
        async function updateCourse(courseId, updateData) {
            try {
                await db.collection('courses').doc(courseId).update({
                    ...updateData,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: currentUser.email
                });
            } catch (error) {
                throw error;
            }
        }
        
        // Add payment to Firestore
        async function addPayment(paymentData) {
            try {
                const docRef = await db.collection('payments').add({
                    ...paymentData,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    recordedBy: currentUser.email,
                    recordedById: currentUser.uid
                });
                
                return docRef.id;
            } catch (error) {
                throw error;
            }
        }
        
        // Add activity to Firestore
        async function addActivity(activityData) {
            try {
                await db.collection('activities').add({
                    ...activityData,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    user: currentUser.email,
                    userId: currentUser.uid
                });
            } catch (error) {
                console.error('Error adding activity:', error);
            }
        }
        
        // ==================== UI FUNCTIONS ====================
        
        // Show login screen
        function showLogin() {
            document.getElementById('login-screen').style.display = 'block';
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('login-error').style.display = 'none';
            document.getElementById('login-email').value = '';
            document.getElementById('login-password').value = '';
        }
        
        // Show main app
        function showApp() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            document.getElementById('user-display-name').textContent = currentUser.email.split('@')[0];
            updateCurrentDate();
        }
        
        // Update current date
        function updateCurrentDate() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            document.getElementById('current-date').textContent = now.toLocaleDateString('en-GB', options);
            document.getElementById('current-year').textContent = now.getFullYear();
        }
        
        // Update dashboard totals
        function updateDashboardTotals() {
            let totalBalance = 0;
            let totalCollected = 0;
            let owingStudents = 0;
            
            students.forEach(student => {
                totalBalance += student.balance || 0;
                totalCollected += student.paid || 0;
                if (student.balance > 0) owingStudents++;
            });
            
            // Add payments total
            payments.forEach(payment => {
                totalCollected += payment.amount || 0;
            });
            
            document.getElementById('total-balance').textContent = totalBalance.toLocaleString();
            document.getElementById('total-collected').textContent = totalCollected.toLocaleString();
            document.getElementById('total-students').textContent = students.length;
            document.getElementById('total-courses').textContent = courses.length;
            document.getElementById('owing-students').textContent = owingStudents;
            
            // Update report totals
            let totalExpected = 0;
            students.forEach(student => {
                totalExpected += student.totalFees || 0;
            });
            
            const collectionRate = totalExpected > 0 ? ((totalCollected / totalExpected) * 100).toFixed(1) : 0;
            
            document.getElementById('report-total-expected').textContent = totalExpected.toLocaleString();
            document.getElementById('report-total-collected').textContent = totalCollected.toLocaleString();
            document.getElementById('report-collection-rate').textContent = collectionRate;
        }
        
        // Populate students table
        function populateStudentsTable() {
            const tableBody = document.getElementById('students-table-body');
            const emptyState = document.getElementById('students-empty');
            
            if (students.length === 0) {
                tableBody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            tableBody.innerHTML = '';
            
            students.forEach(student => {
                const status = student.balance > 0 ? (student.paid > 0 ? 'partial' : 'owing') : 'paid';
                const statusText = status === 'partial' ? 'PARTIAL' : status.toUpperCase();
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.studentId}</td>
                    <td>${student.name}</td>
                    <td>${student.courseName || 'N/A'}</td>
                    <td>₵${(student.totalFees || 0).toLocaleString()}</td>
                    <td>₵${(student.paid || 0).toLocaleString()}</td>
                    <td>₵${(student.balance || 0).toLocaleString()}</td>
                    <td><span class="status ${status}">${statusText}</span></td>
                    <td class="action-buttons">
                        <button class="btn btn-primary btn-sm" onclick="viewStudentDetails('${student.id}')" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-success btn-sm" onclick="recordPaymentForStudent('${student.id}')" title="Record Payment">
                            <i class="fas fa-money-bill"></i>
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="editStudent('${student.id}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // Populate courses table
        function populateCoursesTable() {
            const tableBody = document.getElementById('courses-table-body');
            const emptyState = document.getElementById('courses-empty');
            
            if (courses.length === 0) {
                tableBody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            tableBody.innerHTML = '';
            
            courses.forEach(course => {
                const totalFee = (course.admissionFee || 0) + (course.tuitionFee || 0) + 
                               (course.registrationFee || 0) + (course.hostelFee || 0);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${course.code}</td>
                    <td>${course.name}</td>
                    <td>${course.students || 0}</td>
                    <td>₵${(course.admissionFee || 0).toLocaleString()}</td>
                    <td>₵${(course.tuitionFee || 0).toLocaleString()}</td>
                    <td>₵${(course.registrationFee || 0).toLocaleString()}</td>
                    <td>₵${(course.hostelFee || 0).toLocaleString()}</td>
                    <td>₵${totalFee.toLocaleString()}</td>
                    <td class="action-buttons">
                        <button class="btn btn-primary btn-sm" onclick="editCourse('${course.id}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteCourse('${course.id}')" title="Delete" ${course.students > 0 ? 'disabled' : ''}>
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // Populate fee structure display
        function populateFeeStructure() {
            const container = document.getElementById('fee-structure-container');
            const emptyState = document.getElementById('fees-empty');
            
            if (courses.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            container.innerHTML = '';
            
            courses.forEach(course => {
                const totalFee = (course.admissionFee || 0) + (course.tuitionFee || 0) + 
                               (course.registrationFee || 0) + (course.hostelFee || 0);
                
                const card = document.createElement('div');
                card.className = 'fee-card';
                card.style.cssText = 'background: #f8fafc; border-radius: var(--border-radius); padding: 15px; margin-bottom: 15px; border-left: 4px solid var(--primary-color);';
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div>
                            <h4 style="color: var(--primary-color); margin: 0;">${course.name}</h4>
                            <small style="color: #666;">${course.code} • ${course.students || 0} students enrolled</small>
                        </div>
                        <span style="font-weight: bold; font-size: 1.1rem; color: var(--primary-color);">Total: ₵${totalFee.toLocaleString()}</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-top: 15px;">
                        <div>
                            <span style="font-weight: 600; color: #555;">Admission Fee:</span>
                            <span style="float: right;">₵${(course.admissionFee || 0).toLocaleString()}</span>
                        </div>
                        <div>
                            <span style="font-weight: 600; color: #555;">Tuition Fee:</span>
                            <span style="float: right;">₵${(course.tuitionFee || 0).toLocaleString()}</span>
                        </div>
                        <div>
                            <span style="font-weight: 600; color: #555;">Registration Fee:</span>
                            <span style="float: right;">₵${(course.registrationFee || 0).toLocaleString()}</span>
                        </div>
                        <div>
                            <span style="font-weight: 600; color: #555;">Hostel Fee:</span>
                            <span style="float: right;">₵${(course.hostelFee || 0).toLocaleString()}</span>
                        </div>
                    </div>
                    ${course.description ? `<div style="margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ddd; color: #666;">${course.description}</div>` : ''}
                `;
                container.appendChild(card);
            });
        }
        
        // Populate payment student select
        function populatePaymentStudentSelect() {
            const select = document.getElementById('payment-student');
            select.innerHTML = '<option value="">-- Select Student --</option>';
            
            students.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.studentId} - ${student.name} (Balance: ₵${(student.balance || 0).toLocaleString()})`;
                select.appendChild(option);
            });
        }
        
        // Populate recent payments
        function populateRecentPayments() {
            const tableBody = document.getElementById('recent-payments');
            const emptyState = document.getElementById('payments-empty');
            
            if (payments.length === 0) {
                tableBody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            tableBody.innerHTML = '';
            
            payments.slice(0, 10).forEach(payment => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${payment.date || 'N/A'}</td>
                    <td>${payment.studentName} (${payment.studentId})</td>
                    <td>${payment.method || 'N/A'}</td>
                    <td>${payment.paymentType || 'Regular'}</td>
                    <td>₵${(payment.amount || 0).toLocaleString()}</td>
                    <td>${payment.recordedBy || 'System'}</td>
                    <td>${payment.reference || 'N/A'}</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // Populate recent activities
        function populateRecentActivities() {
            const tableBody = document.getElementById('recent-activities');
            
            // Combine recent payments and student registrations
            const recentActivities = [];
            
            // Add recent payments
            payments.slice(0, 5).forEach(payment => {
                recentActivities.push({
                    date: payment.date,
                    student: payment.studentName,
                    activity: `Payment received via ${payment.method}`,
                    amount: payment.amount,
                    status: 'paid'
                });
            });
            
            // Add recent student registrations
            students.slice(0, 3).forEach(student => {
                recentActivities.push({
                    date: student.admissionDate || '2023-09-01',
                    student: student.name,
                    activity: 'New student registration',
                    amount: 0,
                    status: 'registered'
                });
            });
            
            // Sort by date (newest first)
            recentActivities.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            tableBody.innerHTML = '';
            recentActivities.slice(0, 8).forEach(activity => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${activity.date}</td>
                    <td>${activity.student}</td>
                    <td>${activity.activity}</td>
                    <td>${activity.amount > 0 ? '₵' + activity.amount.toLocaleString() : 'N/A'}</td>
                    <td><span class="status ${activity.status}">${activity.status.toUpperCase()}</span></td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // Populate top balances
        function populateTopBalances() {
            const tableBody = document.getElementById('top-balances');
            
            // Filter students with balance > 0
            const owingStudents = students.filter(s => (s.balance || 0) > 0);
            
            // Sort by balance (highest first)
            owingStudents.sort((a, b) => (b.balance || 0) - (a.balance || 0));
            
            tableBody.innerHTML = '';
            owingStudents.slice(0, 5).forEach(student => {
                const status = student.paid > 0 ? 'partial' : 'owing';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.studentId}</td>
                    <td>${student.name}</td>
                    <td>${student.courseName || 'N/A'}</td>
                    <td>₵${(student.balance || 0).toLocaleString()}</td>
                    <td><span class="status ${status}">${status.toUpperCase()}</span></td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // Populate course selects
        function populateCourseSelects() {
            const studentCourseSelect = document.getElementById('student-course');
            const feesCourseSelect = document.getElementById('select-course-fees');
            
            studentCourseSelect.innerHTML = '<option value="">-- Select Course --</option>';
            feesCourseSelect.innerHTML = '<option value="">-- Select Course --</option>';
            
            courses.forEach(course => {
                const option1 = document.createElement('option');
                option1.value = course.id;
                option1.textContent = `${course.code} - ${course.name}`;
                studentCourseSelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = course.id;
                option2.textContent = `${course.code} - ${course.name}`;
                feesCourseSelect.appendChild(option2);
            });
        }
        
        // Populate owing students table
        function populateOwingStudentsTable() {
            const tableBody = document.getElementById('owing-students-table');
            const emptyState = document.getElementById('owing-empty');
            
            // Filter students with balance > 0
            const owingStudents = students.filter(s => (s.balance || 0) > 0);
            
            if (owingStudents.length === 0) {
                tableBody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            tableBody.innerHTML = '';
            
            owingStudents.forEach(student => {
                // Find the most recent payment for this student
                const studentPayments = payments.filter(p => p.studentId === student.studentId);
                let lastPayment = 'None';
                
                if (studentPayments.length > 0) {
                    studentPayments.sort((a, b) => new Date(b.date) - new Date(a.date));
                    lastPayment = studentPayments[0].date;
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.studentId}</td>
                    <td>${student.name}</td>
                    <td>${student.courseName || 'N/A'}</td>
                    <td>${student.phone || 'N/A'}</td>
                    <td>₵${(student.balance || 0).toLocaleString()}</td>
                    <td>${lastPayment}</td>
                    <td class="action-buttons">
                        <button class="btn btn-success btn-sm" onclick="recordPaymentForStudent('${student.id}')" title="Record Payment">
                            <i class="fas fa-money-bill"></i>
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="viewStudentDetails('${student.id}')" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // ==================== STUDENT FUNCTIONS ====================
        
        // View student details
        async function viewStudentDetails(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            // Get course details
            const course = courses.find(c => c.id === student.courseId);
            
            // Get student payments
            const studentPayments = payments.filter(p => p.studentId === student.studentId);
            
            let content = `
                <div style="margin-bottom: 20px;">
                    <h4 style="color: var(--primary-color); margin-bottom: 15px;">Student Information</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="font-weight: 600; color: #555;">Student ID:</label>
                            <p>${student.studentId}</p>
                        </div>
                        <div>
                            <label style="font-weight: 600; color: #555;">Full Name:</label>
                            <p>${student.name}</p>
                        </div>
                        <div>
                            <label style="font-weight: 600; color: #555;">Course:</label>
                            <p>${student.courseName || 'N/A'}</p>
                        </div>
                        <div>
                            <label style="font-weight: 600; color: #555;">Phone:</label>
                            <p>${student.phone || 'N/A'}</p>
                        </div>
                        <div>
                            <label style="font-weight: 600; color: #555;">Email:</label>
                            <p>${student.email || 'N/A'}</p>
                        </div>
                        <div>
                            <label style="font-weight: 600; color: #555;">Gender:</label>
                            <p>${student.gender || 'N/A'}</p>
                        </div>
                        <div>
                            <label style="font-weight: 600; color: #555;">Hostel Status:</label>
                            <p>${student.hostel || 'No'}</p>
                        </div>
                        <div>
                            <label style="font-weight: 600; color: #555;">Admission Date:</label>
                            <p>${student.admissionDate || 'N/A'}</p>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="color: var(--primary-color); margin-bottom: 15px;">Fee Information</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="font-weight: 600; color: #555;">Total Fees:</label>
                            <p>₵${(student.totalFees || 0).toLocaleString()}</p>
                        </div>
                        <div>
                            <label style="font-weight: 600; color: #555;">Amount Paid:</label>
                            <p>₵${(student.paid || 0).toLocaleString()}</p>
                        </div>
                        <div>
                            <label style="font-weight: 600; color: #555;">Balance:</label>
                            <p>₵${(student.balance || 0).toLocaleString()}</p>
                        </div>
                        <div>
                            <label style="font-weight: 600; color: #555;">Status:</label>
                            <p><span class="status ${student.balance > 0 ? 'owing' : 'paid'}">${student.balance > 0 ? 'OWING' : 'PAID'}</span></p>
                        </div>
                    </div>
                </div>
            `;
            
            if (studentPayments.length > 0) {
                content += `
                    <div>
                        <h4 style="color: var(--primary-color); margin-bottom: 15px;">Payment History</h4>
                        <div style="max-height: 200px; overflow-y: auto;">
                            <table style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th style="padding: 8px; border-bottom: 1px solid #ddd;">Date</th>
                                        <th style="padding: 8px; border-bottom: 1px solid #ddd;">Amount</th>
                                        <th style="padding: 8px; border-bottom: 1px solid #ddd;">Method</th>
                                        <th style="padding: 8px; border-bottom: 1px solid #ddd;">Type</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                studentPayments.forEach(payment => {
                    content += `
                        <tr>
                            <td style="padding: 8px; border-bottom: 1px solid #eee;">${payment.date}</td>
                            <td style="padding: 8px; border-bottom: 1px solid #eee;">₵${(payment.amount || 0).toLocaleString()}</td>
                            <td style="padding: 8px; border-bottom: 1px solid #eee;">${payment.method}</td>
                            <td style="padding: 8px; border-bottom: 1px solid #eee;">${payment.paymentType || 'Regular'}</td>
                        </tr>
                    `;
                });
                
                content += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('student-details-content').innerHTML = content;
            document.getElementById('view-student-modal').classList.add('active');
        }
        
        // Record payment for specific student
        function recordPaymentForStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            // Switch to payments page
            switchPage('payments');
            
            // Set the student in the payment form
            document.getElementById('payment-student').value = studentId;
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('payment-date').value = today;
            
            // Focus on amount field
            setTimeout(() => {
                document.getElementById('payment-amount').focus();
            }, 100);
        }
        
        // Edit student
        async function editStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            // For now, just show details - in a real app, you'd have an edit form
            viewStudentDetails(studentId);
        }
        
        // ==================== COURSE FUNCTIONS ====================
        
        // Edit course
        function editCourse(courseId) {
            const course = courses.find(c => c.id === courseId);
            if (!course) return;
            
            // Switch to fees page and open set fees modal
            switchPage('fees');
            setTimeout(() => {
                document.getElementById('set-fees-modal').classList.add('active');
                document.getElementById('select-course-fees').value = courseId;
                updateFeeConfigurationForm(courseId);
            }, 300);
        }
        
        // Delete course
        async function deleteCourse(courseId) {
            const course = courses.find(c => c.id === courseId);
            if (!course) return;
            
            if (course.students > 0) {
                alert(`Cannot delete course. There are ${course.students} students enrolled in this course.`);
                return;
            }
            
            if (confirm(`Are you sure you want to delete the course "${course.name}"? This action cannot be undone.`)) {
                try {
                    await db.collection('courses').doc(courseId).delete();
                    showAlert('Course deleted successfully!', 'success');
                } catch (error) {
                    console.error('Error deleting course:', error);
                    showAlert('Error deleting course: ' + error.message, 'error');
                }
            }
        }
        
        // Update fee configuration form
        function updateFeeConfigurationForm(courseId) {
            const course = courses.find(c => c.id === courseId);
            if (!course) return;
            
            const feeConfig = document.getElementById('fee-configuration');
            feeConfig.innerHTML = `
                <h4 style="color: var(--primary-color); margin-bottom: 20px;">${course.code} - ${course.name}</h4>
                <form id="update-fee-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="update-admission-fee">Admission Fee (₵)</label>
                            <input type="number" class="form-control" id="update-admission-fee" min="0" value="${course.admissionFee || 0}" required>
                        </div>
                        <div class="form-group">
                            <label for="update-tuition-fee">Tuition Fee (₵)</label>
                            <input type="number" class="form-control" id="update-tuition-fee" min="0" value="${course.tuitionFee || 0}" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="update-registration-fee">Registration Fee (₵)</label>
                            <input type="number" class="form-control" id="update-registration-fee" min="0" value="${course.registrationFee || 0}" required>
                        </div>
                        <div class="form-group">
                            <label for="update-hostel-fee">Hostel Fee (₵)</label>
                            <input type="number" class="form-control" id="update-hostel-fee" min="0" value="${course.hostelFee || 0}" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="update-course-description">Description (Optional)</label>
                        <textarea class="form-control" id="update-course-description" rows="3">${course.description || ''}</textarea>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Update Fee Structure
                        </button>
                        <button type="button" class="btn btn-secondary" id="cancel-update-fees">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </form>
            `;
            
            // Add event listener for form submission
            document.getElementById('update-fee-form').addEventListener('submit', function(e) {
                e.preventDefault();
                updateCourseFees(courseId);
            });
            
            document.getElementById('cancel-update-fees').addEventListener('click', function() {
                document.getElementById('set-fees-modal').classList.remove('active');
            });
        }
        
        // Update course fees
        async function updateCourseFees(courseId) {
            try {
                const admissionFee = parseInt(document.getElementById('update-admission-fee').value);
                const tuitionFee = parseInt(document.getElementById('update-tuition-fee').value);
                const registrationFee = parseInt(document.getElementById('update-registration-fee').value);
                const hostelFee = parseInt(document.getElementById('update-hostel-fee').value);
                const description = document.getElementById('update-course-description').value;
                
                // Update course in Firestore
                await updateCourse(courseId, {
                    admissionFee: admissionFee,
                    tuitionFee: tuitionFee,
                    registrationFee: registrationFee,
                    hostelFee: hostelFee,
                    description: description
                });
                
                // Update all students in this course
                const studentsInCourse = students.filter(s => s.courseId === courseId);
                
                for (const student of studentsInCourse) {
                    const baseFees = admissionFee + tuitionFee + registrationFee;
                    const totalFees = baseFees + (student.hostel === 'Yes' ? hostelFee : 0);
                    const balance = totalFees - (student.paid || 0);
                    
                    await updateStudent(student.id, {
                        totalFees: totalFees,
                        balance: balance,
                        status: balance > 0 ? 'owing' : 'paid'
                    });
                }
                
                // Close modal
                document.getElementById('set-fees-modal').classList.remove('active');
                
                showAlert('Fee structure updated successfully! All affected students have been updated.', 'success');
                
            } catch (error) {
                console.error("Error updating course fees:", error);
                showAlert("Error updating fee structure: " + error.message, 'error');
            }
        }
        
        // ==================== UTILITY FUNCTIONS ====================
        
        // Switch between pages
        function switchPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(pageId).classList.add('active');
            
            // Update active menu item
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            document.querySelector(`.menu-item[data-page="${pageId}"]`).classList.add('active');
        }
        
        // Show alert message
        function showAlert(message, type = 'success') {
            // Create alert element
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" style="background: none; border: none; cursor: pointer; color: inherit;">&times;</button>
            `;
            
            // Add to top of content area
            const contentArea = document.querySelector('.content-area');
            contentArea.insertBefore(alertDiv, contentArea.firstChild);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 5000);
        }
        
        // Export data to CSV
        function exportToCSV(data, filename) {
            if (data.length === 0) {
                showAlert('No data to export', 'warning');
                return;
            }
            
            // Get headers
            const headers = Object.keys(data[0]);
            
            // Create CSV content
            let csvContent = headers.join(',') + '\n';
            
            data.forEach(item => {
                const row = headers.map(header => {
                    const value = item[header];
                    return typeof value === 'string' ? `"${value.replace(/"/g, '""')}"` : value;
                }).join(',');
                csvContent += row + '\n';
            });
            
            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        
        // Generate receipt
        function generateReceipt(paymentData, studentData) {
            const receiptContent = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <h2 style="color: var(--primary-color);">FIRST SCLASS SHS</h2>
                    <p>Fee Payment Receipt</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="font-weight: 600;">Receipt No:</span>
                        <span>${paymentData.reference || 'N/A'}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="font-weight: 600;">Date:</span>
                        <span>${paymentData.date}</span>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: var(--border-radius);">
                    <h4 style="color: var(--primary-color); margin-bottom: 10px;">Student Information</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <span style="font-weight: 600;">Student ID:</span>
                            <p>${studentData.studentId}</p>
                        </div>
                        <div>
                            <span style="font-weight: 600;">Name:</span>
                            <p>${studentData.name}</p>
                        </div>
                        <div>
                            <span style="font-weight: 600;">Course:</span>
                            <p>${studentData.courseName}</p>
                        </div>
                        <div>
                            <span style="font-weight: 600;">Phone:</span>
                            <p>${studentData.phone || 'N/A'}</p>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="color: var(--primary-color); margin-bottom: 10px;">Payment Details</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <span style="font-weight: 600;">Payment Type:</span>
                            <p>${paymentData.paymentType}</p>
                        </div>
                        <div>
                            <span style="font-weight: 600;">Method:</span>
                            <p>${paymentData.method}</p>
                        </div>
                        <div>
                            <span style="font-weight: 600;">Amount:</span>
                            <p>₵${paymentData.amount.toLocaleString()}</p>
                        </div>
                        <div>
                            <span style="font-weight: 600;">Received By:</span>
                            <p>${paymentData.recordedBy}</p>
                        </div>
                    </div>
                </div>
                
                ${paymentData.notes ? `
                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: var(--border-radius);">
                    <span style="font-weight: 600;">Notes:</span>
                    <p>${paymentData.notes}</p>
                </div>
                ` : ''}
                
                <div style="margin-top: 30px; padding-top: 15px; border-top: 2px solid #ddd; text-align: center;">
                    <p>Thank you for your payment!</p>
                    <p style="font-size: 0.9rem; color: #666;">This is an electronically generated receipt. No signature required.</p>
                </div>
            `;
            
            document.getElementById('receipt-content').innerHTML = receiptContent;
            document.getElementById('receipt-modal').classList.add('active');
        }
        
        // Print receipt
        function printReceipt() {
            const receiptContent = document.getElementById('receipt-content').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Payment Receipt</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h2 { color: #1a5f7a; }
                        .receipt-info { margin-bottom: 20px; }
                        .student-info { background: #f8f9fa; padding: 15px; margin-bottom: 20px; }
                        .payment-info { margin-bottom: 20px; }
                        .footer { margin-top: 30px; padding-top: 15px; border-top: 2px solid #ddd; text-align: center; }
                    </style>
                </head>
                <body>
                    ${receiptContent}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
        
        // ==================== EVENT LISTENERS ====================
        
        // DOM Content Loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Set current date
            updateCurrentDate();
            
            // Set default date for payment form to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('payment-date').value = today;
            document.getElementById('admission-date').value = today;
            
            // ==================== LOGIN EVENT ====================
            document.getElementById('login-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                const errorDiv = document.getElementById('login-error');
                
                try {
                    await handleLogin(email, password);
                    errorDiv.style.display = 'none';
                } catch (error) {
                    errorDiv.textContent = error.message;
                    errorDiv.style.display = 'block';
                }
            });
            
            // ==================== LOGOUT EVENT ====================
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            
            // ==================== MENU NAVIGATION ====================
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', function() {
                    const pageId = this.getAttribute('data-page');
                    switchPage(pageId);
                });
            });
            
            // ==================== STUDENT EVENTS ====================
            document.getElementById('add-student-btn').addEventListener('click', function() {
                document.getElementById('add-student-modal').classList.add('active');
            });
            
            document.getElementById('close-student-modal').addEventListener('click', function() {
                document.getElementById('add-student-modal').classList.remove('active');
            });
            
            document.getElementById('cancel-student-form').addEventListener('click', function() {
                document.getElementById('add-student-modal').classList.remove('active');
            });
            
            document.getElementById('student-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                try {
                    // Get form values
                    const studentId = document.getElementById('student-id').value.trim();
                    const studentName = document.getElementById('student-name').value.trim();
                    const courseId = document.getElementById('student-course').value;
                    const phone = document.getElementById('student-phone').value.trim();
                    const email = document.getElementById('student-email').value.trim();
                    const hostel = document.getElementById('student-hostel').value;
                    const gender = document.getElementById('student-gender').value;
                    const admissionDate = document.getElementById('admission-date').value;
                    const initialPayment = parseInt(document.getElementById('initial-payment').value) || 0;
                    const address = document.getElementById('student-address').value.trim();
                    
                    // Validation
                    if (!studentId || !studentName || !courseId) {
                        throw new Error('Please fill in all required fields');
                    }
                    
                    // Find selected course
                    const course = courses.find(c => c.id === courseId);
                    if (!course) {
                        throw new Error('Selected course not found');
                    }
                    
                    // Calculate total fees
                    const baseFees = (course.admissionFee || 0) + (course.tuitionFee || 0) + (course.registrationFee || 0);
                    const totalFees = baseFees + (hostel === 'Yes' ? (course.hostelFee || 0) : 0);
                    const balance = totalFees - initialPayment;
                    
                    // Prepare student data
                    const studentData = {
                        studentId: studentId,
                        name: studentName,
                        courseId: courseId,
                        courseName: course.name,
                        courseCode: course.code,
                        phone: phone,
                        email: email,
                        hostel: hostel,
                        gender: gender,
                        admissionDate: admissionDate,
                        address: address,
                        totalFees: totalFees,
                        paid: initialPayment,
                        balance: balance,
                        status: balance > 0 ? 'owing' : 'paid'
                    };
                    
                    // Add to Firestore
                    await addStudent(studentData);
                    
                    // Record initial payment if any
                    if (initialPayment > 0) {
                        const paymentData = {
                            studentId: studentId,
                            studentName: studentName,
                            amount: initialPayment,
                            date: admissionDate || today,
                            method: 'Cash',
                            paymentType: 'Admission',
                            notes: 'Initial payment on registration',
                            reference: 'INIT-' + Date.now()
                        };
                        
                        await addPayment(paymentData);
                    }
                    
                    // Add activity
                    await addActivity({
                        type: 'student_added',
                        description: `New student added: ${studentName} (${studentId})`,
                        studentId: studentId,
                        studentName: studentName
                    });
                    
                    // Reset form and close modal
                    document.getElementById('student-form').reset();
                    document.getElementById('admission-date').value = today;
                    document.getElementById('add-student-modal').classList.remove('active');
                    
                    showAlert(`Student ${studentName} added successfully!`, 'success');
                    
                } catch (error) {
                    console.error('Error adding student:', error);
                    showAlert('Error adding student: ' + error.message, 'error');
                }
            });
            
            // ==================== COURSE EVENTS ====================
            document.getElementById('add-course-btn').addEventListener('click', function() {
                document.getElementById('add-course-modal').classList.add('active');
            });
            
            document.getElementById('close-course-modal').addEventListener('click', function() {
                document.getElementById('add-course-modal').classList.remove('active');
            });
            
            document.getElementById('cancel-course-form').addEventListener('click', function() {
                document.getElementById('add-course-modal').classList.remove('active');
            });
            
            document.getElementById('course-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                try {
                    // Get form values
                    const courseCode = document.getElementById('course-code').value.trim().toUpperCase();
                    const courseName = document.getElementById('course-name').value.trim();
                    const admissionFee = parseInt(document.getElementById('admission-fee').value);
                    const tuitionFee = parseInt(document.getElementById('tuition-fee').value);
                    const registrationFee = parseInt(document.getElementById('registration-fee').value);
                    const hostelFee = parseInt(document.getElementById('hostel-fee').value);
                    const description = document.getElementById('course-description').value.trim();
                    
                    // Validation
                    if (!courseCode || !courseName || isNaN(admissionFee) || isNaN(tuitionFee) || 
                        isNaN(registrationFee) || isNaN(hostelFee)) {
                        throw new Error('Please fill in all required fields with valid numbers');
                    }
                    
                    // Prepare course data
                    const courseData = {
                        code: courseCode,
                        name: courseName,
                        admissionFee: admissionFee,
                        tuitionFee: tuitionFee,
                        registrationFee: registrationFee,
                        hostelFee: hostelFee,
                        description: description
                    };
                    
                    // Add to Firestore
                    await addCourse(courseData);
                    
                    // Add activity
                    await addActivity({
                        type: 'course_added',
                        description: `New course added: ${courseName} (${courseCode})`,
                        courseCode: courseCode,
                        courseName: courseName
                    });
                    
                    // Reset form and close modal
                    document.getElementById('course-form').reset();
                    document.getElementById('add-course-modal').classList.remove('active');
                    
                    showAlert(`Course ${courseName} added successfully!`, 'success');
                    
                } catch (error) {
                    console.error('Error adding course:', error);
                    showAlert('Error adding course: ' + error.message, 'error');
                }
            });
            
            // ==================== PAYMENT EVENTS ====================
            document.getElementById('set-fees-btn').addEventListener('click', function() {
                document.getElementById('set-fees-modal').classList.add('active');
            });
            
            document.getElementById('close-fees-modal').addEventListener('click', function() {
                document.getElementById('set-fees-modal').classList.remove('active');
            });
            
            document.getElementById('select-course-fees').addEventListener('change', function() {
                if (this.value) {
                    updateFeeConfigurationForm(this.value);
                }
            });
            
            // Payment form submission
            document.getElementById('payment-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                try {
                    // Get form values
                    const studentId = document.getElementById('payment-student').value;
                    const amount = parseInt(document.getElementById('payment-amount').value);
                    const date = document.getElementById('payment-date').value;
                    const method = document.getElementById('payment-method').value;
                    const paymentType = document.getElementById('payment-type').value;
                    const reference = document.getElementById('payment-reference').value.trim();
                    const notes = document.getElementById('payment-notes').value.trim();
                    
                    // Validation
                    if (!studentId || !amount || !date || !method || !paymentType) {
                        throw new Error('Please fill in all required fields');
                    }
                    
                    if (amount <= 0) {
                        throw new Error('Amount must be greater than 0');
                    }
                    
                    // Find student
                    const student = students.find(s => s.id === studentId);
                    if (!student) {
                        throw new Error('Selected student not found');
                    }
                    
                    // Update student payment
                    const newPaid = (student.paid || 0) + amount;
                    const newBalance = (student.totalFees || 0) - newPaid;
                    
                    await updateStudent(studentId, {
                        paid: newPaid,
                        balance: newBalance,
                        status: newBalance > 0 ? 'owing' : 'paid',
                        lastPaymentDate: date
                    });
                    
                    // Create payment record
                    const paymentData = {
                        studentId: student.studentId,
                        studentName: student.name,
                        amount: amount,
                        date: date,
                        method: method,
                        paymentType: paymentType,
                        reference: reference || ('PAY-' + Date.now()),
                        notes: notes,
                        course: student.courseName,
                        studentCourseId: student.courseId
                    };
                    
                    await addPayment(paymentData);
                    
                    // Add activity
                    await addActivity({
                        type: 'payment_received',
                        description: `Payment of ₵${amount} received from ${student.name} via ${method}`,
                        studentId: student.studentId,
                        studentName: student.name,
                        amount: amount
                    });
                    
                    // Generate receipt
                    generateReceipt(paymentData, student);
                    
                    // Reset form
                    document.getElementById('payment-form').reset();
                    document.getElementById('payment-date').value = today;
                    
                    showAlert(`Payment of ₵${amount.toLocaleString()} recorded successfully for ${student.name}`, 'success');
                    
                } catch (error) {
                    console.error('Error recording payment:', error);
                    showAlert('Error recording payment: ' + error.message, 'error');
                }
            });
            
            document.getElementById('clear-payment-form').addEventListener('click', function() {
                document.getElementById('payment-form').reset();
                document.getElementById('payment-date').value = today;
            });
            
            // ==================== REPORT EVENTS ====================
            document.getElementById('view-all-balances').addEventListener('click', function() {
                switchPage('reports');
            });
            
            document.getElementById('export-owing-btn').addEventListener('click', function() {
                const owingStudents = students.filter(s => (s.balance || 0) > 0);
                if (owingStudents.length === 0) {
                    showAlert('No students are currently owing fees', 'warning');
                    return;
                }
                
                const data = owingStudents.map(student => ({
                    'Student ID': student.studentId,
                    'Name': student.name,
                    'Course': student.courseName,
                    'Phone': student.phone || 'N/A',
                    'Email': student.email || 'N/A',
                    'Total Fees': student.totalFees || 0,
                    'Amount Paid': student.paid || 0,
                    'Balance': student.balance || 0,
                    'Status': student.balance > 0 ? 'OWING' : 'PAID'
                }));
                
                exportToCSV(data, `owing_students_${new Date().toISOString().split('T')[0]}.csv`);
            });
            
            document.getElementById('export-students-btn').addEventListener('click', function() {
                const data = students.map(student => ({
                    'Student ID': student.studentId,
                    'Name': student.name,
                    'Course': student.courseName,
                    'Phone': student.phone || 'N/A',
                    'Email': student.email || 'N/A',
                    'Gender': student.gender || 'N/A',
                    'Hostel': student.hostel || 'No',
                    'Total Fees': student.totalFees || 0,
                    'Amount Paid': student.paid || 0,
                    'Balance': student.balance || 0,
                    'Status': student.balance > 0 ? 'OWING' : 'PAID',
                    'Admission Date': student.admissionDate || 'N/A'
                }));
                
                exportToCSV(data, `students_${new Date().toISOString().split('T')[0]}.csv`);
            });
            
            document.getElementById('export-payments-btn').addEventListener('click', function() {
                const data = payments.map(payment => ({
                    'Date': payment.date,
                    'Student ID': payment.studentId,
                    'Student Name': payment.studentName,
                    'Course': payment.course || 'N/A',
                    'Payment Type': payment.paymentType || 'Regular',
                    'Method': payment.method,
                    'Amount': payment.amount,
                    'Reference': payment.reference || 'N/A',
                    'Notes': payment.notes || '',
                    'Recorded By': payment.recordedBy,
                    'Recorded At': payment.timestamp ? new Date(payment.timestamp.seconds * 1000).toLocaleString() : 'N/A'
                }));
                
                exportToCSV(data, `payments_${new Date().toISOString().split('T')[0]}.csv`);
            });
            
            document.getElementById('generate-report-btn').addEventListener('click', function() {
                // Calculate report data
                let totalFeesExpected = 0;
                let totalFeesCollected = 0;
                
                students.forEach(student => {
                    totalFeesExpected += student.totalFees || 0;
                    totalFeesCollected += student.paid || 0;
                });
                
                const outstandingFees = totalFeesExpected - totalFeesCollected;
                const collectionRate = totalFeesExpected > 0 ? ((totalFeesCollected / totalFeesExpected) * 100).toFixed(2) : 0;
                const owingStudents = students.filter(s => (s.balance || 0) > 0).length;
                
                // Create report content
                const reportContent = `
FIRST SCLASS SHS - FEE COLLECTION REPORT
Generated on: ${new Date().toLocaleDateString()}
Generated by: ${currentUser.email}

SUMMARY:
------------
Total Students: ${students.length}
Total Courses: ${courses.length}
Total Fees Expected: ₵${totalFeesExpected.toLocaleString()}
Total Fees Collected: ₵${totalFeesCollected.toLocaleString()}
Outstanding Fees: ₵${outstandingFees.toLocaleString()}
Collection Rate: ${collectionRate}%
Students Owing Fees: ${owingStudents}

STUDENTS WITH OUTSTANDING BALANCES:
------------
${students.filter(s => (s.balance || 0) > 0).map(s => `${s.studentId} - ${s.name} (${s.courseName}): ₵${(s.balance || 0).toLocaleString()}`).join('\n') || 'None'}

COURSE WISE FEE STRUCTURE:
------------
${courses.map(c => {
    const total = (c.admissionFee || 0) + (c.tuitionFee || 0) + (c.registrationFee || 0) + (c.hostelFee || 0);
    return `${c.code} - ${c.name}: ₵${total.toLocaleString()} (Admission: ₵${(c.admissionFee || 0).toLocaleString()}, Tuition: ₵${(c.tuitionFee || 0).toLocaleString()}, Registration: ₵${(c.registrationFee || 0).toLocaleString()}, Hostel: ₵${(c.hostelFee || 0).toLocaleString()}) - Students: ${c.students || 0}`;
}).join('\n')}

RECENT PAYMENTS (Last 10):
------------
${payments.slice(0, 10).map(p => `${p.date} - ${p.studentName}: ₵${(p.amount || 0).toLocaleString()} (${p.method})`).join('\n')}
                `;
                
                // Display report in alert
                alert(reportContent);
            });
            
            document.getElementById('print-report-btn').addEventListener('click', function() {
                window.print();
            });
            
            document.getElementById('send-reminders-btn').addEventListener('click', function() {
                const owingStudents = students.filter(s => (s.balance || 0) > 0);
                if (owingStudents.length === 0) {
                    showAlert('No students are currently owing fees', 'warning');
                    return;
                }
                
                if (confirm(`Send fee reminders to ${owingStudents.length} students? This will show a confirmation message.`)) {
                    showAlert(`Fee reminders sent to ${owingStudents.length} students. In a real system, this would send emails/SMS.`, 'success');
                }
            });
            
            // ==================== SETTINGS EVENTS ====================
            document.getElementById('save-settings').addEventListener('click', function() {
                showAlert('Settings saved successfully!', 'success');
            });
            
            document.getElementById('backup-data-btn').addEventListener('click', function() {
                if (confirm('Export all data as backup files?')) {
                    // Export students
                    const studentsData = students.map(student => ({
                        ...student,
                        id: undefined // Remove Firestore document ID
                    }));
                    exportToCSV(studentsData, `students_backup_${new Date().toISOString().split('T')[0]}.csv`);
                    
                    // Export courses
                    const coursesData = courses.map(course => ({
                        ...course,
                        id: undefined
                    }));
                    exportToCSV(coursesData, `courses_backup_${new Date().toISOString().split('T')[0]}.csv`);
                    
                    // Export payments
                    const paymentsData = payments.map(payment => ({
                        ...payment,
                        id: undefined,
                        timestamp: payment.timestamp ? new Date(payment.timestamp.seconds * 1000).toISOString() : ''
                    }));
                    exportToCSV(paymentsData, `payments_backup_${new Date().toISOString().split('T')[0]}.csv`);
                    
                    showAlert('Backup completed! Three CSV files have been downloaded.', 'success');
                }
            });
            
            document.getElementById('clear-data-btn').addEventListener('click', function() {
                if (confirm('WARNING: This will clear all test data. This action cannot be undone. Are you sure?')) {
                    showAlert('Data clear initiated. In a production system, this would delete all data.', 'warning');
                }
            });
            
            // ==================== SEARCH FUNCTIONALITY ====================
            document.getElementById('student-search').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const tableBody = document.getElementById('students-table-body');
                const rows = tableBody.querySelectorAll('tr');
                let visibleCount = 0;
                
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    if (text.includes(searchTerm)) {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                });
                
                const emptyState = document.getElementById('students-empty');
                if (visibleCount === 0 && searchTerm) {
                    emptyState.innerHTML = `
                        <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 15px;"></i>
                        <h3>No Students Found</h3>
                        <p>No students match your search criteria</p>
                    `;
                    emptyState.style.display = 'block';
                } else if (visibleCount === 0) {
                    emptyState.style.display = 'block';
                } else {
                    emptyState.style.display = 'none';
                }
            });
            
            document.getElementById('course-search').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const tableBody = document.getElementById('courses-table-body');
                const rows = tableBody.querySelectorAll('tr');
                let visibleCount = 0;
                
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    if (text.includes(searchTerm)) {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                });
                
                const emptyState = document.getElementById('courses-empty');
                if (visibleCount === 0 && searchTerm) {
                    emptyState.innerHTML = `
                        <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 15px;"></i>
                        <h3>No Courses Found</h3>
                        <p>No courses match your search criteria</p>
                    `;
                    emptyState.style.display = 'block';
                } else if (visibleCount === 0) {
                    emptyState.style.display = 'block';
                } else {
                    emptyState.style.display = 'none';
                }
            });
            
            // ==================== RECEIPT MODAL EVENTS ====================
            document.getElementById('close-receipt-modal').addEventListener('click', function() {
                document.getElementById('receipt-modal').classList.remove('active');
            });
            
            document.getElementById('close-receipt-btn').addEventListener('click', function() {
                document.getElementById('receipt-modal').classList.remove('active');
            });
            
            document.getElementById('print-receipt-btn').addEventListener('click', printReceipt);
            
            // ==================== VIEW STUDENT MODAL EVENTS ====================
            document.getElementById('close-view-student-modal').addEventListener('click', function() {
                document.getElementById('view-student-modal').classList.remove('active');
            });
            
            // ==================== REFRESH BUTTONS ====================
            document.getElementById('refresh-activities').addEventListener('click', function() {
                populateRecentActivities();
                showAlert('Activities refreshed!', 'success');
            });
            
            document.getElementById('refresh-payments').addEventListener('click', function() {
                populateRecentPayments();
                showAlert('Payments refreshed!', 'success');
            });
            
            // ==================== INITIALIZE CURRENT USER ====================
            document.getElementById('current-user').value = currentUser ? currentUser.email : 'Not logged in';
            document.getElementById('last-updated').value = new Date().toLocaleString();
        });
    </script>
</body>
</html>